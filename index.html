<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Honguito</title>
        <!-- Favicon-->
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <!-- Bootstrap icons-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />
    </head>
    <body>
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container px-4 px-lg-5">

                <a class="navbar-brand" href="#!">
                    <img src="img/mushroom.png" class="pr-4" style="height: 40px; padding-right: 10px;" alt="Responsive image">
                    Honguito
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0 ms-lg-4">
                        <li class="nav-item"><a class="nav-link active" aria-current="page" href="#!">Inicio</a></li>
                        <li class="nav-item"><a class="nav-link" href="#!">Acerca de</a></li>
                    </ul>
                </div>
            </div>
        </nav>
        <!-- Product section-->
        <section class="py-5">
            <div class="container px-4 px-lg-5 my-5">
                <div class="row gx-4 gx-lg-5 align-items-center">

                    <h2 class="display-6 fw-bolder">Calculadora de Interés Compuesto</h2>
                    <p class="lead">Completa la información para realizar el cálculo del interés compuesto.</p>

                    <div class="col-md-6">
                        <form>
                            <div class="form-group">
                                <h4 class="display-7 fw-bolder">Paso 1: Estado inicial</h4>
                                <input type="number" class="form-control" id="initial_amount" aria-describedby="initialAmountHelp" placeholder="1000000" value="1000000">
                                <small class="form-text text-muted">Escribe el monto inicial con el que comenzarás la inversión, por ejemplo, $1.000.000</small>
                            </div>

                            <div class="form-group">
                                <h4 class="display-7 fw-bolder">Paso 2: Aportes</h4>
                                <input type="number" class="form-control" id="contribution_amount" aria-describedby="contributionAmountHelp" placeholder="500000" value="500000">
                                <small class="form-text text-muted">Escribe el monto mensual que depositarás, por ejemplo, $500.000</small>
                            </div>

                            <div class="form-group">
                                <h4 class="display-7 fw-bolder">Paso 3: Intereses</h4>
                                <input class="form-control" id="interest_amount" aria-describedby="interestAmountHelp" placeholder="0.10" value="0.10" step="0.01" min="0" type="number" max="1.0">
                                <small class="form-text text-muted">Escribe el interés anual que tu dinero rendirá, por ejemplo, 0.10 (10%)</small>
                            </div>

                            <div class="form-group">
                                <h4 class="display-7 fw-bolder">Paso 4: Duración</h4>
                                <input type="number" class="form-control" id="years" aria-describedby="yearsHelp" placeholder="10" value="10">
                                <small class="form-text text-muted">Escribe número de años por el cual realizarás los aportes</small>
                            </div>

                            <p class="lead">Por último, da click en el botón para realizar el cálculo.</p>

                            <div class="d-flex pb-4">
                                <button class="btn btn-outline-dark flex-shrink-0" type="submit">
                                    <i class="bi bi-calculator me-1"></i>
                                    Calcular
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="col-md-6">
                        <ul class="nav nav-tabs" id="myTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="general-chart" data-bs-toggle="tab"
                                        data-bs-target="#general_canvas_div" type="button" role="tab" aria-controls="General"
                                        aria-selected="true">General</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="profile-tab" data-bs-toggle="tab"
                                        data-bs-target="#detailed_canvas_div" type="button" role="tab" aria-controls="Detallado"
                                        aria-selected="false">Detallado</button>
                            </li>
                        </ul>
                        <div class="tab-content" id="myTabContent">
                            <div id="general_canvas_div" class="tab-pane fade show active" role="tabpanel" aria-labelledby="general-chart">
                                <canvas id="general_canvas" style="width:100%;max-width:700px"></canvas>
                            </div>
                            <div id="detailed_canvas_div" class="tab-pane fade" role="tabpanel" aria-labelledby="profile-tab">
                                <canvas id="detailed_canvas" style="width:100%;max-width:700px"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- Related items section-->
        <section class="py-5 bg-light">
            <div class="container px-4 px-lg-5 mt-5">
                <h2 class="fw-bolder mb-4">Resumen</h2>
                <div class="row" id="summary">
                    <ul>
                        <li>Completa la información de arriba para conocer el resumen de tu inversión</li>
                    </ul>
                </div>
            </div>
        </section>
        <!-- Footer-->
        <footer class="py-5 bg-dark">
            <div class="container"><p class="m-0 text-center text-white">Copyright &copy; Honguito 2022</p></div>
        </footer>
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>

        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js" integrity="sha512-zInFF17qBFVvvvFpIfeBzo7Tj7+rQxLeTJDmbxjBz5/zIr89YVbTNelNhdTT+/DCrxoVzBeUPVFJsczKbB7sew==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

        <script type='text/javascript'>
            $(document).ready(function(){
                init();

                $("form").submit(function(e){
                    e.preventDefault(e);

                    init();
                });
            });

            function init(){
                var initial_amount = Number($("#initial_amount").val());
                var contribution_amount = Number($("#contribution_amount").val());
                var contribution_period = 12 // months
                var interest_amount = Number($("#interest_amount").val());
                var period_in_years = Number($("#years").val());
                var base_amounts = Array(period_in_years).fill(initial_amount);
                var contributions_per_period = [];
                var interests_per_period = [];

                var contribution_sum = 0
                var interest_sum = 0
                var final_balances = [];
                var initial_balance = initial_amount;

                for (let i = 1; i <= period_in_years; i++) {
                    annual_contribution = contribution_amount * contribution_period;
                    contribution_sum = contribution_sum + annual_contribution;
                    final_balance = compoundInterest(i, initial_amount, annual_contribution, interest_amount);
                    positive_interest = final_balance - initial_balance - annual_contribution;
                    interest_sum = interest_sum + positive_interest;

                    final_balances.push(final_balance);
                    contributions_per_period.push(contribution_sum);
                    interests_per_period.push(interest_sum);

                    console.log('Balance Inicial: ' + initial_balance);
                    console.log('Aportaciones anuales: ' + annual_contribution);
                    console.log('Aportaciones acumuladas: ' + contribution_sum);
                    console.log('Interés devengado: ' + positive_interest);
                    console.log('Interés acumulado: ' + interest_sum);
                    console.log('Balance final: ' + final_balance);
                    console.log('===='+i+'====');

                    initial_balance = final_balance;
                }

                build_chart(
                    period_in_years,
                    final_balances,
                    base_amounts,
                    contributions_per_period,
                    interests_per_period
                );
                build_general_chart(period_in_years, final_balances, contributions_per_period);
                display_final_information(
                    initial_amount,
                    annual_contribution,
                    contribution_sum,
                    positive_interest,
                    interest_sum,
                    final_balance
                )
            };

            function compoundInterest(t, initial, annual, interest_rate) {
                return initial * (1+interest_rate) ** t + annual * (1+interest_rate) * ((1+interest_rate) ** t - 1) / interest_rate;
            };

            function build_general_chart(period_in_years, final_balances, contributions_per_period){
                // Create label names
                const label_names = [];
                for (let i = 1; i <= period_in_years; i++) {
                  label_names.push("Año " + i);
                }

                // Create data
                const data = {
                    labels: label_names,
                    datasets: [
                        {
                            label: 'Con interés',
                            data: final_balances,
                            borderSkipped: false,
                            borderColor: 'red',
                            borderWidth: 1,
                        },
                        {
                            label: 'Sin interés',
                            data: contributions_per_period,
                            borderSkipped: false,
                            borderColor: 'blue',
                            borderWidth: 1,
                        }
                    ]
                };

                // Create config
                const config = {
                    type: 'line',
                    data: data,
                    options: {
                        responsive: true,
                        legend:{
                            display: true
                        },
                        tooltips: {
                            callbacks: {
                                label: function(tooltipItem, data) {
                                    var formatter = new Intl.NumberFormat(
                                        'es-CO',
                                        {
                                            style: 'currency',
                                            currency: 'COP',
                                            maximumFractionDigits: 1
                                        }
                                    );
                                    var label = data.datasets[tooltipItem.datasetIndex].label || '';

                                    if (label) {
                                        label += ': ';
                                    }

                                    if (tooltipItem.value !== null) {
                                        label += formatter.format(tooltipItem.value);
                                    }

                                    return label;
                                }
                            }
                        }
                    }
                };

                // Remove objects from DOM
                $("#general_canvas_div").empty();
                $('#general_canvas_div').append('<canvas id="general_canvas" style="width:100%;max-width:700px"></canvas>');

                // Display new chart
                const ctx = document.getElementById('general_canvas');
                const general_chart = new Chart(
                    ctx,
                    config
                );
            };

            function build_chart(period_in_years, final_balances, base_amounts, contributions_per_period, interests_per_period) {
                // Create label names
                const label_names = [];
                for (let i = 1; i <= period_in_years; i++) {
                  label_names.push("Año " + i);
                }

                var initial_colors = chroma.scale(['a6cee3']).colors(label_names.length);
                var contributions_colors = chroma.scale(['1f78b4']).colors(label_names.length);
                var interests_colors = chroma.scale(['b2df8a']).colors(label_names.length);

                // Create data
                const data = {
                    labels: label_names,
                    datasets: [
                        {
                            label: 'Cantidad Inicial',
                            data: base_amounts,
                            borderSkipped: false,
                            backgroundColor: initial_colors,
                            borderWidth: 1,
                        },
                        {
                            label: 'Aportes',
                            data: contributions_per_period,
                            borderSkipped: false,
                            backgroundColor: contributions_colors,
                            borderWidth: 1,
                        },
                        {
                            label: 'Intereses',
                            data: interests_per_period,
                            borderSkipped: false,
                            backgroundColor: interests_colors,
                            borderWidth: 1,
                        },

                    ]
                };

                // Create config
                const config = {
                    type: 'bar',
                    data: data,
                    options: {
                        scales: {
                            xAxes: [{
                                stacked: true
                            }],
                            yAxes: [{
                                stacked: true
                            }]
                        },
                        responsive: true,
                        legend:{
                            display: true
                        },
                        tooltips: {
                            callbacks: {
                                label: function(tooltipItem, data) {
                                    var formatter = new Intl.NumberFormat(
                                        'es-CO',
                                        {
                                            style: 'currency',
                                            currency: 'COP',
                                            maximumFractionDigits: 1
                                        }
                                    );
                                    var label = data.datasets[tooltipItem.datasetIndex].label || '';

                                    if (label) {
                                        label += ': ';
                                    }

                                    if (tooltipItem.value !== null) {
                                        label += formatter.format(tooltipItem.value);
                                    }

                                    return label;
                                }
                            }
                        }
                    }
                };

                // Remove objects from DOM
                $("#detailed_canvas_div").empty();
                $('#detailed_canvas_div').append('<canvas id="detailed_canvas" style="width:100%;max-width:700px"></canvas>');

                // Display new chart
                const ctx = document.getElementById('detailed_canvas');
                const detailed_chart = new Chart(
                    ctx,
                    config
                );
            }

            function display_final_information(initial_amount, annual_contribution, contribution_sum, positive_interest, interest_sum, final_balance){

                var formatter = new Intl.NumberFormat('es-CO', {style: 'currency',currency: 'COP',maximumFractionDigits: 1});

                initial_amount = formatter.format(initial_amount);
                annual_contribution = formatter.format(annual_contribution);
                contribution_sum = formatter.format(contribution_sum);
                positive_interest = formatter.format(positive_interest);
                interest_sum = formatter.format(interest_sum);
                final_balance = formatter.format(final_balance);

                $("#summary").empty();
                $('#summary').append('<ul id="facts"></ul>');

                $('#facts').append('<li>Iniciaste con ' + initial_amount + '</li>');
                $('#facts').append('<li>Con tus contribuciones mensuales ahorraste ' + contribution_sum + '</li>');
                $('#facts').append('<li>Si hubieras ahorrado debajo de tu colchón hubieras perdido ' + interest_sum + ', pero como ahorraste con interés compuesto, ¡ganaste! </li>');
                $('#facts').append('<li>Y bueno... en total hoy tienes ' + final_balance + '</li>');
                $('#summary').append('<h4>¡Felicitaciones!</h4>');

            }
        </script>
    </body>
</html>
